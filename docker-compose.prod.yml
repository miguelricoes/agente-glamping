# ğŸ”’ DOCKER COMPOSE PRODUCCIÃ“N - CONFIGURACIÃ“N SEGURA
# Solo para uso en producciÃ³n con mÃ¡xima seguridad

version: '3.8'

services:
  # ğŸ¤– AplicaciÃ³n principal del agente (PRODUCCIÃ“N)
  agente-glamping:
    build:
      context: .
      dockerfile: Dockerfile
      # Optimizaciones de build para producciÃ³n
      args:
        - BUILDKIT_INLINE_CACHE=1
    
    # ğŸŒ SOLO puerto interno (usar reverse proxy en producciÃ³n)
    expose:
      - "8080"
    
    # ğŸ” Variables de entorno SEGURAS para producciÃ³n
    environment:
      - ENV=production
      - PORT=8080
      - LOG_LEVEL=WARNING
      - STRUCTURED_LOGS=true
      - CONSOLE_LOGS=false
      - LOG_FILE=/app/logs/agente_glamping.log
      # Variables de base de datos desde secretos
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
      - POSTGRES_DB_FILE=/run/secrets/postgres_db
      - POSTGRES_USER_FILE=/run/secrets/postgres_user
      - POSTGRES_PASSWORD_FILE=/run/secrets/postgres_password
    
    # ğŸ“ VolÃºmenes LIMITADOS para producciÃ³n
    volumes:
      # SOLO logs (read-only filesystem excepto logs)
      - production_logs:/app/logs:rw
      - /app/data:ro  # Datos read-only
    
    # ğŸ¥ Health check mÃ¡s agresivo
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 60s
    
    # ğŸ”„ Reinicio automÃ¡tico
    restart: always
    
    # ğŸ›¡ï¸ MÃXIMA SEGURIDAD
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
    read_only: true
    tmpfs:
      - /tmp:noexec,nosuid,size=100m
      - /app/cache:noexec,nosuid,size=200m
    
    # ğŸ“Š LÃ­mites de recursos ESTRICTOS
    deploy:
      mode: replicated
      replicas: 2
      resources:
        limits:
          memory: 2G
          cpus: '1.0'
        reservations:
          memory: 1G
          cpus: '0.5'
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
        window: 120s
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
    
    # ğŸ”— Dependencias con health checks
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    
    # ğŸ” Secretos de Docker
    secrets:
      - postgres_db
      - postgres_user
      - postgres_password
      - openai_api_key
      - twilio_auth_token
    
    # ğŸŒ Redes
    networks:
      - agente-backend
    
    # ğŸ·ï¸ Labels para monitoreo
    labels:
      - "traefik.enable=false"  # No exposiciÃ³n directa
      - "com.agente-glamping.tier=application"
      - "com.agente-glamping.env=production"

  # ğŸ—„ï¸ PostgreSQL PRODUCCIÃ“N (configuraciÃ³n segura)
  postgres:
    image: postgres:15-alpine
    
    # ğŸ” ConfiguraciÃ³n SEGURA
    environment:
      POSTGRES_DB_FILE: /run/secrets/postgres_db
      POSTGRES_USER_FILE: /run/secrets/postgres_user  
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_HOST_AUTH_METHOD: scram-sha-256
      POSTGRES_INITDB_ARGS: --auth-host=scram-sha-256
    
    # ğŸ“ Volumen para persistencia SEGURA
    volumes:
      - postgres_production_data:/var/lib/postgresql/data
      # ConfiguraciÃ³n de PostgreSQL optimizada
      - ./config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./config/pg_hba.conf:/etc/postgresql/pg_hba.conf:ro
    
    # ğŸš« NO exponer puertos en producciÃ³n
    expose:
      - "5432"
    
    # ğŸ¥ Health check
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $(cat /run/secrets/postgres_user) -d $(cat /run/secrets/postgres_db)"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    
    # ğŸ”„ Reinicio automÃ¡tico
    restart: always
    
    # ğŸ›¡ï¸ Seguridad mÃ¡xima
    security_opt:
      - no-new-privileges:true
      - apparmor:docker-default
    
    # ğŸ“Š LÃ­mites de recursos
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
    
    # ğŸ” Secretos
    secrets:
      - postgres_db
      - postgres_user
      - postgres_password
    
    # ğŸŒ Redes
    networks:
      - agente-backend
    
    # ğŸ·ï¸ Labels
    labels:
      - "com.agente-glamping.tier=database"
      - "com.agente-glamping.env=production"

  # ğŸ“Š Redis PRODUCCIÃ“N
  redis:
    image: redis:7-alpine
    
    # ğŸ”§ ConfiguraciÃ³n optimizada y SEGURA
    command: >
      redis-server
      --appendonly yes
      --maxmemory 256mb
      --maxmemory-policy allkeys-lru
      --save 900 1
      --save 300 10
      --save 60 10000
      --requirepass $(cat /run/secrets/redis_password)
    
    # ğŸ“ Volumen para persistencia
    volumes:
      - redis_production_data:/data
    
    # ğŸš« NO exponer puertos
    expose:
      - "6379"
    
    # ğŸ¥ Health check con autenticaciÃ³n
    healthcheck:
      test: ["CMD", "redis-cli", "--no-auth-warning", "-a", "$(cat /run/secrets/redis_password)", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    
    # ğŸ”„ Reinicio automÃ¡tico
    restart: always
    
    # ğŸ›¡ï¸ Seguridad
    security_opt:
      - no-new-privileges:true
    
    # ğŸ“Š LÃ­mites de recursos
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.3'
        reservations:
          memory: 256M
          cpus: '0.1'
    
    # ğŸ” Secretos
    secrets:
      - redis_password
    
    # ğŸŒ Redes
    networks:
      - agente-backend
    
    # ğŸ·ï¸ Labels
    labels:
      - "com.agente-glamping.tier=cache"
      - "com.agente-glamping.env=production"

# ğŸ” SECRETOS DE PRODUCCIÃ“N (definir externamente)
secrets:
  postgres_db:
    external: true
    name: agente_postgres_db
  postgres_user:
    external: true
    name: agente_postgres_user
  postgres_password:
    external: true
    name: agente_postgres_password
  redis_password:
    external: true
    name: agente_redis_password
  openai_api_key:
    external: true
    name: agente_openai_api_key
  twilio_auth_token:
    external: true
    name: agente_twilio_auth_token

# ğŸ“ VolÃºmenes SEGUROS para producciÃ³n
volumes:
  postgres_production_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/lib/agente-glamping/postgres
    labels:
      com.agente-glamping.description: "Base de datos PostgreSQL - PRODUCCIÃ“N"
      com.agente-glamping.backup: "required"
  
  redis_production_data:
    driver: local
    driver_opts:
      type: none  
      o: bind
      device: /var/lib/agente-glamping/redis
    labels:
      com.agente-glamping.description: "Cache Redis - PRODUCCIÃ“N"
  
  production_logs:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: /var/log/agente-glamping
    labels:
      com.agente-glamping.description: "Logs de aplicaciÃ³n - PRODUCCIÃ“N"

# ğŸŒ Redes SEGURAS
networks:
  agente-backend:
    driver: bridge
    internal: true  # RED INTERNA - no acceso externo directo
    labels:
      com.agente-glamping.description: "Red interna backend - SOLO comunicaciÃ³n entre servicios"
    ipam:
      config:
        - subnet: 172.21.0.0/16

# ğŸ·ï¸ Metadatos del proyecto PRODUCCIÃ“N
labels:
  com.agente-glamping.version: "2.0.0"
  com.agente-glamping.description: "Sistema de chatbot para glamping con IA - PRODUCCIÃ“N"
  com.agente-glamping.environment: "production"
  com.agente-glamping.security-level: "high"